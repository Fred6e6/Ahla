<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>البيانات المرسلة | Ahla</title>
<script src="js/roleGuard.js"></script>
<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
img{width:70px;margin:4px;border:1px solid #ccc}
</style>
</head>
<body>

<h2>آخر إرسال</h2>
<div id="out"></div>

<script type="module">
import { supabase } from "./supabase.js";

const user = localStorage.getItem("user");

const { data: batch } = await supabase
  .from("batches")
  .select("*")
  .eq("user_name", user)
  .order("created_at", { ascending:false })
  .limit(1)
  .single();

const { data: items } = await supabase
  .from("items")
  .select("*")
  .eq("batch_id", batch.id);

const { data: images } = await supabase
  .storage.from("batch-images")
  .list(batch.id);

let h = "<table border=1><tr><th>#</th><th>الصنف</th><th>الكمية</th></tr>";
items.forEach((i,idx)=>{
  h += `<tr><td>${idx+1}</td><td>${i.code}</td><td>${i.qty}</td></tr>`;
});
h += "</table><h3>الصور</h3>";

images.forEach(img=>{
  const url = supabase.storage.from("batch-images")
    .getPublicUrl(`${batch.id}/${img.name}`).data.publicUrl;
  h += `<img src="${url}">`;
});

out.innerHTML = h;
</script>

</body>
</html>
