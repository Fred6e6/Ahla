<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المدير | Ahla</title>
<script src="js/roleGuard.js"></script>
<style>
body{font-family:Tahoma;background:#f2f2f2;padding:20px}
img{width:70px;margin:4px;border:1px solid #ccc}
</style>
</head>

<body>

<h2>البيانات المستلمة</h2>
<div id="all"></div>

<script type="module">
import { supabase } from "./supabase.js";

if(localStorage.getItem("role")!=="admin"){
  alert("غير مصرح"); location.href="index.html";
}

const { data: batches } = await supabase
  .from("batches")
  .select("*")
  .order("created_at",{ascending:false});

for(const b of batches){
  const { data: items } = await supabase
    .from("items").select("*").eq("batch_id",b.id);

  const { data: images } = await supabase
    .storage.from("batch-images").list(b.id);

  let html = `<h3>${b.user_name} - ${b.created_at}</h3>`;
  html += "<table border=1><tr><th>#</th><th>الصنف</th><th>الكمية</th></tr>";
  items.forEach((i,idx)=>{
    html += `<tr><td>${idx+1}</td><td>${i.code}</td><td>${i.qty}</td></tr>`;
  });
  html += "</table>";

  images.forEach(img=>{
    const url = supabase.storage.from("batch-images")
      .getPublicUrl(`${b.id}/${img.name}`).data.publicUrl;
    html += `<img src="${url}">`;
  });

  all.innerHTML += html + "<hr>";
}
</script>

</body>
</html>
