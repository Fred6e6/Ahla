<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± | Ahla</title>

<script src="js/roleGuard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Tahoma;background:#f2f2f2;padding:20px}
nav{background:#222;padding:10px;margin-bottom:15px;display:flex;gap:8px;flex-wrap:wrap}
nav button{background:#6c757d;color:#fff;border:none;padding:7px 12px;border-radius:6px;cursor:pointer}
nav .logout{background:#dc3545}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#343a40;color:#fff}
img{width:70px;margin:4px;border:1px solid #ccc;border-radius:6px}
.export{background:#198754;color:#fff;margin-bottom:10px}
.download{background:#0d6efd;color:#fff;margin:3px}
.small{font-size:12px;color:#444}
hr{margin:16px 0}
</style>
</head>

<body>

<nav>
  <button type="button" onclick="location.href='admin.html'">ğŸ“¥ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</button>
  <button type="button" onclick="location.href='sent.html'">ğŸ“¤ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
  <button type="button" class="logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<script>
if (localStorage.getItem("role") !== "admin") {
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
  location.href = "index.html";
}
</script>

<h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
<button class="export" onclick="exportExcel()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>

<div id="all"></div>

<script>
const batches = JSON.parse(localStorage.getItem("ahla_batches")) || [];
const container = document.getElementById("all");

if (batches.length === 0) {
  container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>";
}

batches.forEach((b, i) => {
  let h = `
    <h3>Ø¯ÙØ¹Ø© ${i + 1}</h3>
    <p class="small">
      <b>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</b> ${b.user} â€”
      <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${b.date} â€”
      <b>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</b> ${b.id}
    </p>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
      </thead>
      <tbody>
  `;

  (b.items || []).forEach((it, idx) => {
    h += `
      <tr>
        <td>${idx + 1}</td>
        <td>${it.code}</td>
        <td>${it.qty}</td>
        <td>${it.price}</td>
        <td>${it.total}</td>
      </tr>
    `;
  });

  h += `</tbody></table><div>`;

  (b.images || []).forEach((img, x) => {
    h += `
      <div style="display:inline-block;text-align:center">
        <img src="${img}">
        <br>
        <button class="download" onclick="downloadImage('${img}','batch_${i+1}_img_${x+1}.png')">
          ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        </button>
      </div>
    `;
  });

  h += `</div><hr>`;
  container.innerHTML += h;
});

/* ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Base64 */
function downloadImage(base64, filename){
  const a = document.createElement("a");
  a.href = base64;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* ØªØµØ¯ÙŠØ± Excel (Ù…Ø¹ Ø¹Ù…ÙˆØ¯ ÙØ§Ø±Øº Ø¨ÙŠÙ† Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ) */
function exportExcel(){
  if (batches.length === 0) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
    return;
  }

  const rows = [];
  batches.forEach((b, bi) => {
    (b.items || []).forEach(it => {
      rows.push({
        Ø§Ù„Ø¯ÙØ¹Ø©: bi + 1,
        Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: b.user,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: b.date,
        Ø±Ù‚Ù…_Ø§Ù„ØµÙ†Ù: it.code,
        Ø§Ù„ÙƒÙ…ÙŠØ©: it.qty,
        Ø§Ù„Ø³Ø¹Ø±: it.price,
        "": "",          // Ø¹Ù…ÙˆØ¯ ÙØ§Ø±Øº
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: it.total
      });
    });
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ahla Data");
  XLSX.writeFile(wb, "ahla-data.xlsx");
}
</script>

<script src="js/auth.js"></script>
</body>
</html>
