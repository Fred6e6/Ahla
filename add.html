<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>
<script src="js/roleGuard.js"></script>

<style>
  body{font-family:Tahoma;background:#f5f5f5;padding:20px}
  h2{margin:0 0 12px;text-align:center}
  table{width:100%;background:#fff;border-collapse:collapse}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  th{background:#9ccbc7}
  input{width:100%;padding:6px;box-sizing:border-box}
  button{padding:7px 12px;border:none;border-radius:6px;cursor:pointer}
  .add{background:#6c757d;color:#fff}
  .save{background:#198754;color:#fff}
  .delete{background:#dc3545;color:#fff}
  .bar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:10px}
  .note{font-size:12px;color:#333}
  img.thumb{width:46px;height:46px;object-fit:cover;border-radius:6px;margin:2px;border:1px solid #ccc}
</style>
</head>

<body>

<div class="bar">
  <div class="note">
    Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b id="who"></b> â€” (ÙƒÙ„ Ø­ÙØ¸ = Ø¯ÙØ¹Ø© Ù…Ø³ØªÙ‚Ù„Ø©)
  </div>
  <div>
    <button class="save" type="button" onclick="goSent()">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
  </div>
</div>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
  <thead>
    <tr>
      <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
      <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      <th>Ø§Ù„ØµÙˆØ± (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØŒ Ù…ØªØ¹Ø¯Ø¯)</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td><input id="code" /></td>
      <td><input value="Ø­Ø¨Ø©" disabled /></td>
      <td><input id="qty" type="number" min="1" /></td>
      <td><input id="price" type="number" min="0" step="0.01" /></td>
      <td><input id="total" type="number" min="0" step="0.01" /></td>
      <td><input id="images" type="file" accept="image/*" multiple /></td>
      <td>
        <button class="add" type="button" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </td>
    </tr>
  </tbody>
</table>

<br />

<table id="dataTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
      <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
      <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      <th>ØµÙˆØ± Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div style="margin-top:10px;text-align:center">
  <button class="save" type="button" onclick="saveBatch()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø©)</button>
</div>

<script>
  // ---- Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ----
  const username = localStorage.getItem("user") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  document.getElementById("who").textContent = username;

  // ---- Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ----
  const KEY_BATCHES = "ahla_batches";            // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª
  const KEY_LAST_SENT = "ahla_last_sent_batch";  // Ø¢Ø®Ø± Ø¯ÙØ¹Ø© ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ sent.html

  // ---- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ----
  const codeInput = document.getElementById("code");
  const qtyInput = document.getElementById("qty");
  const priceInput = document.getElementById("price");
  const totalInput = document.getElementById("total");
  const imagesInput = document.getElementById("images");
  const addBtn = document.getElementById("addBtn");

  // ---- Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ© (Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸) ----
  let buffer = []; // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·

  // ---- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠ ----
  let lastEdited = null; // "price" Ø£Ùˆ "total"

  priceInput.addEventListener("input", () => {
    lastEdited = "price";
    const q = Number(qtyInput.value);
    const p = Number(priceInput.value);
    if (q > 0 && p >= 0) totalInput.value = (q * p).toFixed(2);
  });

  totalInput.addEventListener("input", () => {
    lastEdited = "total";
    const q = Number(qtyInput.value);
    const t = Number(totalInput.value);
    if (q > 0 && t >= 0) priceInput.value = (t / q).toFixed(2);
  });

  qtyInput.addEventListener("input", () => {
    const q = Number(qtyInput.value);
    if (q <= 0) return;
    // Ø¥Ø°Ø§ Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ -> Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø³Ø¹Ø±
    if (lastEdited === "total" && totalInput.value !== "") {
      const t = Number(totalInput.value);
      if (t >= 0) priceInput.value = (t / q).toFixed(2);
    }
    // Ø¥Ø°Ø§ Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± -> Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    if (lastEdited === "price" && priceInput.value !== "") {
      const p = Number(priceInput.value);
      if (p >= 0) totalInput.value = (q * p).toFixed(2);
    }
  });

  // ---- Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ----
  addBtn.addEventListener("click", addItem);

  async function addItem() {
    const code = codeInput.value.trim();
    const qty = Number(qtyInput.value);

    if (!code || !(qty > 0)) {
      alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
      return;
    }

    // Ø§Ù„ØµÙˆØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠ + Ù…ØªØ¹Ø¯Ø¯
    const files = Array.from(imagesInput.files || []);
    if (files.length === 0) {
      alert("Ø§Ù„ØµÙˆØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©)");
      return;
    }

    // Ù†Ø­ÙˆÙ„ ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ù„Ù€ Base64 (Ù„ÙƒÙ„ ØµÙ†Ù Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„)
    const images = await Promise.all(files.map(fileToDataURL));

    // Ù†Ø«Ø¨Øª Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ø°Ø§ Ø£Ø­Ø¯Ù‡Ù…Ø§ ÙØ§Ø¶ÙŠ Ù†Ø­Ø³Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø¢Ø®Ø±)
    const q = qty;
    let p = priceInput.value === "" ? null : Number(priceInput.value);
    let t = totalInput.value === "" ? null : Number(totalInput.value);

    if (p === null && t !== null && q > 0) p = Number((t / q).toFixed(2));
    if (t === null && p !== null && q > 0) t = Number((q * p).toFixed(2));
    if (p === null) p = 0;
    if (t === null) t = 0;

    buffer.push({
      user: username,
      code,
      unit: "Ø­Ø¨Ø©",
      qty: q,
      price: p,
      total: t,
      images // <-- ØµÙˆØ± Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù ÙÙ‚Ø·
    });

    renderBuffer();
    clearInputs();
  }

  function clearInputs() {
    codeInput.value = "";
    qtyInput.value = "";
    priceInput.value = "";
    totalInput.value = "";
    imagesInput.value = "";
    lastEdited = null;
  }

  function renderBuffer() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    buffer.forEach((item, i) => {
      const imgsHtml = item.images.map(src => `<img class="thumb" src="${src}" />`).join("");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${item.user}</td>
        <td>${item.code}</td>
        <td>${item.unit}</td>
        <td>${item.qty}</td>
        <td>${item.price}</td>
        <td>${item.total}</td>
        <td>${imgsHtml}</td>
        <td><button class="delete" type="button" onclick="removeItem(${i})">Ø­Ø°Ù</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  window.removeItem = function(i) {
    buffer.splice(i, 1);
    renderBuffer();
  };

  // ---- Ø­ÙØ¸ Ø¯ÙØ¹Ø© Ù…Ø³ØªÙ‚Ù„Ø© (Ù„Ø§ Ø¯Ù…Ø¬) ----
  function saveBatch() {
    if (buffer.length === 0) {
      alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸");
      return;
    }

    const batchId = makeBatchId();
    const createdAt = new Date().toISOString();

    const batches = JSON.parse(localStorage.getItem(KEY_BATCHES)) || [];
    batches.push({
      batchId,
      createdAt,
      sender: username,
      items: buffer
    });

    localStorage.setItem(KEY_BATCHES, JSON.stringify(batches));
    localStorage.setItem(KEY_LAST_SENT, batchId);

    // ØªÙØ±ÙŠØº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    buffer = [];
    renderBuffer();

    // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© (ØªØ¹Ø±Ø¶ Ø¢Ø®Ø± Ø¯ÙØ¹Ø©)
    window.location.href = "sent.html";
  }

  function goSent() {
    window.location.href = "sent.html";
  }

  function makeBatchId() {
    // Ù…Ø¹Ø±Ù‘Ù Ø¯ÙØ¹Ø© Ø´Ø¨Ù‡ ÙØ±ÙŠØ¯
    return "B" + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }
</script>

<script src="js/auth.js"></script>
</body>
</html>
