<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>
<script src="js/roleGuard.js"></script>

<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
nav{background:#343a40;padding:10px;margin-bottom:15px}
nav button{background:#6c757d;color:#fff;border:none;padding:7px 12px;margin:3px;border-radius:5px;cursor:pointer}
nav button.logout{background:#dc3545}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#9ccbc7}
input{width:100%;padding:6px}
button{cursor:pointer}
.add{background:#6c757d;color:#fff;padding:6px 12px;border:none;border-radius:5px}
.save{background:#198754;color:#fff;padding:8px 14px;border:none;border-radius:6px;margin-top:10px}
img{width:64px;margin:4px;border:1px solid #ccc;border-radius:6px}
</style>
</head>

<body>

<nav>
  <button onclick="location.href='add.html'">â• Ø¥Ø¯Ø®Ø§Ù„</button>
  <button onclick="location.href='sent.html'">ğŸ“¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
  <button class="logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
<tr>
  <td><input id="code"></td>
  <td><input value="Ø­Ø¨Ø©" disabled></td>
  <td><input id="qty" type="number"></td>
  <td><input id="price" type="number"></td>
  <td><input id="total" type="number"></td>
  <td><button class="add" onclick="addItem()">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</table>

<br>

<table id="itemsTable">
<thead>
<tr><th>#</th><th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø°Ù</th></tr>
</thead>
<tbody></tbody>
</table>

<hr>

<h3>ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</h3>
<input id="batchImages" type="file" multiple accept="image/*">
<div id="preview"></div>

<button class="save" onclick="send()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<script>
const codeInput=code.value,qtyInput=qty,priceInput=price,totalInput=total;
const imagesInp=batchImages,previewDiv=preview;
let items=[],lastEdit=null;

priceInput.oninput=()=>{lastEdit="price"; if(qtyInput.value) totalInput.value=(qtyInput.value*priceInput.value).toFixed(2);}
totalInput.oninput=()=>{lastEdit="total"; if(qtyInput.value) priceInput.value=(totalInput.value/qtyInput.value).toFixed(2);}
qtyInput.oninput=()=>{ if(!qtyInput.value)return;
  if(lastEdit==="price") totalInput.value=(qtyInput.value*priceInput.value).toFixed(2);
  if(lastEdit==="total") priceInput.value=(totalInput.value/qtyInput.value).toFixed(2);
}

function addItem(){
  if(!codeInput.value||!qtyInput.value) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  items.push({code:codeInput.value,qty:qtyInput.value,price:priceInput.value,total:totalInput.value});
  render();
  codeInput.value=qtyInput.value=priceInput.value=totalInput.value="";
}

function render(){
  const tb=document.querySelector("#itemsTable tbody");
  tb.innerHTML="";
  items.forEach((i,x)=>tb.innerHTML+=`<tr><td>${x+1}</td><td>${i.code}</td><td>${i.qty}</td><td>${i.price}</td><td>${i.total}</td><td><button onclick="items.splice(${x},1);render()">âœ–</button></td></tr>`);
}

imagesInp.onchange=()=>{
  previewDiv.innerHTML="";
  [...imagesInp.files].forEach(f=>{
    const r=new FileReader();
    r.onload=()=>previewDiv.innerHTML+=`<img src="${r.result}">`;
    r.readAsDataURL(f);
  });
};

function send(){
  if(items.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù");
  if(imagesInp.files.length===0) return alert("Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©");
  Promise.all([...imagesInp.files].map(f=>new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f);
  }))).then(images=>{
    const batches=JSON.parse(localStorage.getItem("ahla_batches"))||[];
    batches.push({user:localStorage.getItem("user"),date:new Date().toLocaleString(),items,images});
    localStorage.setItem("ahla_batches",JSON.stringify(batches));
    location.href="sent.html";
  });
}
</script>

<script src="js/auth.js"></script>
</body>
</html>
