<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>
<script src="js/roleGuard.js"></script>

<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
nav{background:#222;padding:10px;margin-bottom:15px}
nav button{background:#6c757d;color:#fff;border:none;padding:7px 12px;border-radius:6px;margin:3px;cursor:pointer}
nav .logout{background:#dc3545}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#4f6f6c;color:#fff}
input{width:100%;padding:6px}
img{width:70px;margin:4px;border:1px solid #ccc;border-radius:6px}
.add{background:#6c757d;color:#fff}
.save{background:#198754;color:#fff;padding:8px 16px;border-radius:6px;margin-top:10px}
</style>
</head>

<body>

<nav>
  <button onclick="location.href='add.html'">â• Ø¥Ø¯Ø®Ø§Ù„</button>
  <button onclick="location.href='sent.html'">ğŸ“¤ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
  <button class="logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
<tr>
  <td><input id="code"></td>
  <td><input id="qty" type="number"></td>
  <td><input id="price" type="number"></td>
  <td><input id="total" type="number"></td>
  <td><button class="add" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</table>

<br>

<table id="itemsTable">
<thead>
<tr><th>#</th><th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø°Ù</th></tr>
</thead>
<tbody></tbody>
</table>

<hr>

<h3>ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</h3>
<input id="images" type="file" multiple>
<div id="preview"></div>

<button class="save" id="sendBtn">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<script type="module">
import { supabase } from "./supabase.js";

const user = localStorage.getItem("user");
let items = [];

const code = document.getElementById("code");
const qty = document.getElementById("qty");
const price = document.getElementById("price");
const total = document.getElementById("total");

addBtn.onclick = () => {
  if(!code.value || !qty.value) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  items.push({
    code: code.value,
    qty: Number(qty.value),
    price: Number(price.value || 0),
    total: Number(total.value || qty.value * price.value)
  });
  render();
  code.value = qty.value = price.value = total.value = "";
};

function render(){
  itemsTable.querySelector("tbody").innerHTML = "";
  items.forEach((i,idx)=>{
    itemsTable.querySelector("tbody").innerHTML += `
      <tr>
        <td>${idx+1}</td><td>${i.code}</td><td>${i.qty}</td>
        <td>${i.price}</td><td>${i.total}</td>
        <td><button onclick="items.splice(${idx},1);render()">âœ–</button></td>
      </tr>`;
  });
}

sendBtn.onclick = async () => {
  if(items.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù");
  if(images.files.length===0) return alert("Ø§Ù„ØµÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©");

  const { data: batch } = await supabase
    .from("batches")
    .insert({ user_name: user })
    .select()
    .single();

  await supabase.from("items").insert(
    items.map(i => ({ ...i, batch_id: batch.id }))
  );

  for(const file of images.files){
    await supabase.storage
      .from("batch-images")
      .upload(`${batch.id}/${Date.now()}_${file.name}`, file);
  }

  location.href = "sent.html";
};
</script>

<script src="js/auth.js"></script>
</body>
</html>
