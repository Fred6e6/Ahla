<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>

<script src="js/roleGuard.js"></script>

<style>
body { font-family: Tahoma; background:#f5f5f5; padding:20px }
table { width:100%; background:#fff; border-collapse:collapse }
th,td { padding:8px; text-align:center; border:1px solid #ddd }
th { background:#9ccbc7 }
input { width:100%; padding:5px }
button { padding:6px 12px; cursor:pointer; border:none; border-radius:4px }
.add { background:#6c757d; color:#fff }
.save { background:#198754; color:#fff; margin-top:10px }
.delete { background:#dc3545; color:#fff }
img { width:50px; margin:2px }
</style>
</head>

<body>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø§Ù„ØµÙˆØ± (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
<tr>
  <td><input id="code"></td>
  <td><input value="Ø­Ø¨Ø©" disabled></td>
  <td><input id="qty" type="number"></td>
  <td><input id="price" type="number"></td>
  <td><input id="total" type="number"></td>
  <td><input id="images" type="file" accept="image/*" multiple required></td>
  <td><button type="button" class="add" onclick="addItem()">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</table>

<br>

<table id="dataTable">
<thead>
<tr>
  <th>#</th>
  <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø§Ù„ØµÙˆØ±</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button class="save" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>

<script>
const codeInput = document.getElementById("code");
const qtyInput = document.getElementById("qty");
const priceInput = document.getElementById("price");
const totalInput = document.getElementById("total");
const imagesInput = document.getElementById("images");

const username = localStorage.getItem("user") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

/* ØªØ±Ù‚ÙŠÙ… ØªØ³Ù„Ø³Ù„ÙŠ Ø¹Ø§Ù… */
let globalIndex = Number(localStorage.getItem("ahla_index")) || 1;

/* Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ */
let buffer = [];

/* Ø­Ø³Ø§Ø¨ Ø°ÙƒÙŠ */
qtyInput.oninput = () => priceInput.value && (totalInput.value = qtyInput.value * priceInput.value);
priceInput.oninput = () => totalInput.value = qtyInput.value * priceInput.value;
totalInput.oninput = () => priceInput.value = qtyInput.value ? (totalInput.value / qtyInput.value).toFixed(2) : "";

function addItem() {
  if (!codeInput.value || !qtyInput.value || imagesInput.files.length === 0) {
    alert("Ø±Ù‚Ù… Ø§Ù„ØµÙ†ÙØŒ Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ ÙˆØ§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }

  const imgs = [];
  const files = Array.from(imagesInput.files);
  let loaded = 0;

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      imgs.push(reader.result);
      loaded++;
      if (loaded === files.length) {
        buffer.push({
          index: globalIndex++,
          user: username,
          code: codeInput.value,
          unit: "Ø­Ø¨Ø©",
          qty: qtyInput.value,
          price: priceInput.value,
          total: totalInput.value,
          images: imgs
        });
        render();
        clearInputs();
      }
    };
    reader.readAsDataURL(file);
  });
}

function render() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  buffer.forEach((item,i)=>{
    tbody.innerHTML += `
      <tr>
        <td>${item.index}</td>
        <td>${item.user}</td>
        <td>${item.code}</td>
        <td>${item.unit}</td>
        <td>${item.qty}</td>
        <td>${item.price}</td>
        <td>${item.total}</td>
        <td>${item.images.map(img=>`<img src="${img}">`).join("")}</td>
        <td><button class="delete" onclick="remove(${i})">Ø­Ø°Ù</button></td>
      </tr>`;
  });
}

function remove(i){
  buffer.splice(i,1);
  render();
}

function saveAll() {
  if (buffer.length === 0) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸");
    return;
  }

  const saved = JSON.parse(localStorage.getItem("ahla_data")) || [];
  localStorage.setItem("ahla_data", JSON.stringify(saved.concat(buffer)));
  localStorage.setItem("ahla_index", globalIndex);

  buffer = [];
  render();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
}

function clearInputs(){
  codeInput.value="";
  qtyInput.value="";
  priceInput.value="";
  totalInput.value="";
  imagesInput.value="";
}
</script>

</body>
</html>
