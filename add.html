<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>
<script src="js/roleGuard.js"></script>
<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#9ccbc7}
input{width:100%;padding:6px}
button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
.add{background:#6c757d;color:#fff}
.save{background:#198754;color:#fff;margin-top:12px}
img{width:64px;margin:4px;border:1px solid #ccc;border-radius:6px}
hr{margin:14px 0}
</style>
</head>
<body>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
<tr>
  <td><input id="code"></td>
  <td><input value="Ø­Ø¨Ø©" disabled></td>
  <td><input id="qty" type="number" min="1"></td>
  <td><input id="price" type="number" step="0.01"></td>
  <td><input id="total" type="number" step="0.01"></td>
  <td><button type="button" class="add" onclick="addItem()">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</table>

<br>

<table id="itemsTable">
<thead>
<tr>
  <th>#</th>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody></tbody>
</table>

<hr>

<h3>ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€“ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±)</h3>
<input id="batchImages" type="file" accept="image/*" multiple>
<div id="preview"></div>

<button class="save" onclick="send()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<script>
const username = localStorage.getItem("user") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
const codeInput = document.getElementById("code");
const qtyInput  = document.getElementById("qty");
const priceInput= document.getElementById("price");
const totalInput= document.getElementById("total");
const imagesInp = document.getElementById("batchImages");
const preview   = document.getElementById("preview");

let items = [];
let lastEdit = null;

// Ø­Ø³Ø§Ø¨ Ø°ÙƒÙŠ
priceInput.oninput = ()=>{ lastEdit="price"; if(qtyInput.value) totalInput.value=(qtyInput.value*priceInput.value).toFixed(2); };
totalInput.oninput = ()=>{ lastEdit="total"; if(qtyInput.value) priceInput.value=(totalInput.value/qtyInput.value).toFixed(2); };
qtyInput.oninput   = ()=>{
  if(!qtyInput.value) return;
  if(lastEdit==="price" && priceInput.value) totalInput.value=(qtyInput.value*priceInput.value).toFixed(2);
  if(lastEdit==="total" && totalInput.value) priceInput.value=(totalInput.value/qtyInput.value).toFixed(2);
};

function addItem(){
  if(!codeInput.value || !qtyInput.value) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ©");
  items.push({
    code: codeInput.value,
    unit: "Ø­Ø¨Ø©",
    qty: Number(qtyInput.value),
    price: Number(priceInput.value||0),
    total: Number(totalInput.value||0)
  });
  render();
  codeInput.value=qtyInput.value=priceInput.value=totalInput.value="";
  lastEdit=null;
}

function render(){
  const tb=document.querySelector("#itemsTable tbody");
  tb.innerHTML="";
  items.forEach((it,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${it.code}</td><td>${it.qty}</td>
        <td>${it.price}</td><td>${it.total}</td>
        <td><button onclick="del(${i})">âœ–</button></td>
      </tr>`;
  });
}
function del(i){ items.splice(i,1); render(); }

imagesInp.onchange=()=>{
  preview.innerHTML="";
  Array.from(imagesInp.files).forEach(f=>{
    const r=new FileReader();
    r.onload=()=>preview.innerHTML+=`<img src="${r.result}">`;
    r.readAsDataURL(f);
  });
};

function send(){
  if(items.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù");
  if(imagesInp.files.length===0) return alert("Ø§Ù„ØµÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©");

  const toBase64 = f => new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f);
  });

  Promise.all(Array.from(imagesInp.files).map(toBase64)).then(images=>{
    const batches = JSON.parse(localStorage.getItem("ahla_batches"))||[];
    batches.push({
      id: Date.now(),
      user: username,
      date: new Date().toLocaleString(),
      items: items,
      images: images
    });
    localStorage.setItem("ahla_batches", JSON.stringify(batches));

    // ØªÙØ±ÙŠØº + Ø§Ù†ØªÙ‚Ø§Ù„
    items=[]; render(); imagesInp.value=""; preview.innerHTML="";
    location.href="sent.html";
  });
}
</script>
</body>
</html>
