<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>

<script src="js/roleGuard.js"></script>

<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
nav{background:#222;padding:10px;margin-bottom:15px;display:flex;gap:8px;flex-wrap:wrap}
nav button{background:#6c757d;color:#fff;border:none;padding:7px 12px;border-radius:6px;cursor:pointer}
nav .logout{background:#dc3545}

table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#4f6f6c;color:#fff}

input{width:100%;padding:6px;box-sizing:border-box}

button.add{background:#6c757d;color:#fff;border:none;padding:6px 12px;border-radius:5px;cursor:pointer}
button.save{background:#198754;color:#fff;border:none;padding:8px 16px;border-radius:6px;margin-top:12px;cursor:pointer}

img{width:70px;margin:4px;border:1px solid #ccc;border-radius:6px}
hr{margin:16px 0}
</style>
</head>

<body>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
<nav>
  <button type="button" onclick="location.href='add.html'">â• Ø¥Ø¯Ø®Ø§Ù„</button>
  <button type="button" onclick="location.href='sent.html'">ğŸ“¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
  <button type="button" class="logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<!-- Ø¥Ø¯Ø®Ø§Ù„ ØµÙ†Ù -->
<table>
<thead>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody>
<tr>
  <td><input id="code"></td>
  <td><input value="Ø­Ø¨Ø©" disabled></td>
  <td><input id="qty" type="number" min="1"></td>
  <td><input id="price" type="number" step="0.01"></td>
  <td><input id="total" type="number" step="0.01"></td>
  <td><button type="button" class="add" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</tbody>
</table>

<br>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø¶Ø§ÙØ© -->
<table id="itemsTable">
<thead>
<tr>
  <th>#</th>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody></tbody>
</table>

<hr>

<!-- ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
<h3>ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€“ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±)</h3>
<input id="batchImages" type="file" accept="image/*" multiple>
<div id="preview"></div>

<button class="save" id="sendBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<script>
/* ===============================
   Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
================================ */
const codeInput   = document.getElementById("code");
const qtyInput    = document.getElementById("qty");
const priceInput  = document.getElementById("price");
const totalInput  = document.getElementById("total");
const imagesInput = document.getElementById("batchImages");
const preview     = document.getElementById("preview");
const addBtn      = document.getElementById("addBtn");
const sendBtn     = document.getElementById("sendBtn");

const username = localStorage.getItem("user") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

let items = [];
let lastEdit = null;

/* ===============================
   Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠ (Ù†Ù‡Ø§Ø¦ÙŠ)
================================ */
priceInput.addEventListener("input", () => {
  lastEdit = "price";
  const q = Number(qtyInput.value);
  const p = Number(priceInput.value);
  if (q > 0 && p >= 0) totalInput.value = (q * p).toFixed(2);
});

totalInput.addEventListener("input", () => {
  lastEdit = "total";
  const q = Number(qtyInput.value);
  const t = Number(totalInput.value);
  if (q > 0 && t >= 0) priceInput.value = (t / q).toFixed(2);
});

qtyInput.addEventListener("input", () => {
  const q = Number(qtyInput.value);
  if (q <= 0) return;

  if (lastEdit === "price" && priceInput.value !== "") {
    totalInput.value = (q * Number(priceInput.value)).toFixed(2);
  }
  if (lastEdit === "total" && totalInput.value !== "") {
    priceInput.value = (Number(totalInput.value) / q).toFixed(2);
  }
});

/* ===============================
   Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
================================ */
addBtn.addEventListener("click", () => {
  const code = String(codeInput.value).trim();
  const qty  = Number(qtyInput.value);
  const price = Number(priceInput.value);
  const total = Number(totalInput.value);

  if (code === "" || !Number.isFinite(qty) || qty <= 0) {
    alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
    return;
  }

  items.push({
    code,
    qty,
    price: Number.isFinite(price) ? price : 0,
    total: Number.isFinite(total) ? total : qty * (Number.isFinite(price) ? price : 0)
  });

  renderItems();

  codeInput.value = "";
  qtyInput.value = "";
  priceInput.value = "";
  totalInput.value = "";
  lastEdit = null;
});

/* ===============================
   Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù
================================ */
function renderItems(){
  const tb = document.querySelector("#itemsTable tbody");
  tb.innerHTML = "";

  items.forEach((it,i)=>{
    tb.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${it.code}</td>
        <td>${it.qty}</td>
        <td>${it.price}</td>
        <td>${it.total}</td>
        <td><button onclick="items.splice(${i},1);renderItems()">âœ–</button></td>
      </tr>`;
  });
}

/* ===============================
   Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
================================ */
imagesInput.addEventListener("change", ()=>{
  preview.innerHTML = "";
  [...imagesInput.files].forEach(f=>{
    const r = new FileReader();
    r.onload = ()=> preview.innerHTML += `<img src="${r.result}">`;
    r.readAsDataURL(f);
  });
});

/* ===============================
   Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª = Ø¥Ø±Ø³Ø§Ù„
================================ */
sendBtn.addEventListener("click", ()=>{
  if (items.length === 0) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§");
    return;
  }

  if (imagesInput.files.length === 0) {
    alert("Ø§Ù„ØµÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }

  const toBase64 = f => new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.readAsDataURL(f);
  });

  Promise.all([...imagesInput.files].map(toBase64)).then(images=>{
    const batches = JSON.parse(localStorage.getItem("ahla_batches")) || [];

    batches.push({
      id: Date.now(),
      user: username,
      date: new Date().toLocaleString(),
      items: JSON.parse(JSON.stringify(items)), // Ù†Ø³Ø® Ø¢Ù…Ù†
      images: images
    });

    localStorage.setItem("ahla_batches", JSON.stringify(batches));

    // ØªÙ†Ø¸ÙŠÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    items = [];
    renderItems();
    imagesInput.value = "";
    preview.innerHTML = "";

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
    location.href = "sent.html";
  });
});
</script>

<script src="js/auth.js"></script>
</body>
</html>
