<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>إدخال الأصناف | Ahla</title>

<script src="js/roleGuard.js"></script>

<style>
body { font-family: Tahoma; background:#f5f5f5; padding:20px }
table { width:100%; background:#fff; border-collapse:collapse }
th,td { padding:8px; text-align:center; border:1px solid #ddd }
th { background:#9ccbc7 }
input { width:100%; padding:5px }
button { padding:6px 10px; cursor:pointer }
.add { background:#6c757d; color:#fff }
.save { background:#198754; color:#fff }
.delete { background:#dc3545; color:#fff }
img { width:50px }
</style>
</head>

<body>

<h2>إدخال الأصناف</h2>

<table>
<tr>
  <th>رقم الصنف</th>
  <th>الوحدة</th>
  <th>الكمية</th>
  <th>السعر</th>
  <th>الإجمالي</th>
  <th>الصورة</th>
  <th>إجراء</th>
</tr>
<tr>
  <td><input id="code"></td>
  <td><input value="حبة" disabled></td>
  <td><input id="qty" type="number"></td>
  <td><input id="price" type="number"></td>
  <td><input id="total" type="number"></td>
  <td><input id="img" type="file" accept="image/*"></td>
  <td>
    <button type="button" class="add" id="addBtn">إضافة</button>
    <button type="button" class="save" onclick="saveData()">حفظ</button>
  </td>
</tr>
</table>

<br>

<table id="dataTable">
<thead>
<tr>
  <th>#</th>
  <th>المستخدم</th>
  <th>رقم الصنف</th>
  <th>الوحدة</th>
  <th>الكمية</th>
  <th>السعر</th>
  <th>الإجمالي</th>
  <th>الصورة</th>
  <th>إجراء</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const codeInput = document.getElementById("code");
const qtyInput = document.getElementById("qty");
const priceInput = document.getElementById("price");
const totalInput = document.getElementById("total");
const imgInput = document.getElementById("img");

const username = localStorage.getItem("user") || "غير معروف";
let data = JSON.parse(localStorage.getItem("ahla_data")) || [];

qtyInput.oninput = () => priceInput.value && (totalInput.value = qtyInput.value * priceInput.value);
priceInput.oninput = () => totalInput.value = qtyInput.value * priceInput.value;
totalInput.oninput = () => priceInput.value = qtyInput.value ? (totalInput.value / qtyInput.value).toFixed(2) : "";

document.getElementById("addBtn").addEventListener("click", addItem);

function addItem() {
  if (!codeInput.value || !qtyInput.value) return alert("أدخل رقم الصنف والكمية");

  const reader = new FileReader();
  reader.onload = () => {
    data.push({
      user: username,
      code: codeInput.value,
      unit: "حبة",
      qty: qtyInput.value,
      price: priceInput.value,
      total: totalInput.value,
      img: reader.result
    });
    render();
    clear();
  };
  if (imgInput.files[0]) reader.readAsDataURL(imgInput.files[0]);
  else reader.onload();
}

function render() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  data.forEach((d,i)=>{
    tbody.innerHTML += `
    <tr>
      <td>${i+1}</td>
      <td>${d.user}</td>
      <td>${d.code}</td>
      <td>${d.unit}</td>
      <td>${d.qty}</td>
      <td>${d.price}</td>
      <td>${d.total}</td>
      <td>${d.img ? `<img src="${d.img}">` : ""}</td>
      <td><button class="delete" onclick="del(${i})">حذف</button></td>
    </tr>`;
  });
}

function del(i){
  data.splice(i,1);
  render();
}

function saveData(){
  localStorage.setItem("ahla_data", JSON.stringify(data));
  alert("تم حفظ المدخلات");
}

function clear(){
  codeInput.value="";
  qtyInput.value="";
  priceInput.value="";
  totalInput.value="";
  imgInput.value="";
}

render();
</script>

</body>
</html>
