<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>
<script src="js/roleGuard.js"></script>

<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#9ccbc7}
input{width:100%;padding:6px}
button{padding:7px 12px;border:none;border-radius:5px;cursor:pointer}
.add{background:#6c757d;color:#fff}
.save{background:#198754;color:#fff;margin-top:10px}
img{width:60px;margin:3px;border:1px solid #ccc}
</style>
</head>

<body>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
<tr>
  <td><input id="code"></td>
  <td><input value="Ø­Ø¨Ø©" disabled></td>
  <td><input id="qty" type="number"></td>
  <td><input id="price" type="number"></td>
  <td><input id="total" type="number"></td>
  <td><button type="button" class="add" onclick="addItem()">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</table>

<br>

<table id="itemsTable">
<thead>
<tr>
  <th>#</th>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody></tbody>
</table>

<hr>

<h3>ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€“ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±)</h3>
<input id="batchImages" type="file" accept="image/*" multiple>

<div id="preview"></div>

<button class="save" onclick="saveBatch()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<script>
const username = localStorage.getItem("user") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

const codeInput = document.getElementById("code");
const qtyInput = document.getElementById("qty");
const priceInput = document.getElementById("price");
const totalInput = document.getElementById("total");
const imagesInput = document.getElementById("batchImages");
const preview = document.getElementById("preview");

let items = [];

qtyInput.oninput = () => priceInput.value && (totalInput.value = qtyInput.value * priceInput.value);
priceInput.oninput = () => totalInput.value = qtyInput.value * priceInput.value;
totalInput.oninput = () => priceInput.value = qtyInput.value ? (totalInput.value / qtyInput.value).toFixed(2) : "";

function addItem(){
  if(!codeInput.value || !qtyInput.value) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ©");

  items.push({
    code: codeInput.value,
    qty: qtyInput.value,
    price: priceInput.value,
    total: totalInput.value
  });

  renderItems();
  codeInput.value = qtyInput.value = priceInput.value = totalInput.value = "";
}

function renderItems(){
  const tbody = document.querySelector("#itemsTable tbody");
  tbody.innerHTML = "";
  items.forEach((it,i)=>{
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${it.code}</td>
        <td>${it.qty}</td>
        <td>${it.price}</td>
        <td>${it.total}</td>
        <td><button onclick="removeItem(${i})">âœ–</button></td>
      </tr>`;
  });
}

function removeItem(i){
  items.splice(i,1);
  renderItems();
}

imagesInput.onchange = () => {
  preview.innerHTML = "";
  Array.from(imagesInput.files).forEach(f=>{
    const r = new FileReader();
    r.onload = () => preview.innerHTML += `<img src="${r.result}">`;
    r.readAsDataURL(f);
  });
};

function saveBatch(){
  if(items.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù");
  if(imagesInput.files.length === 0) return alert("Ø§Ù„ØµÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©");

  const readers = Array.from(imagesInput.files).map(f=>new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.readAsDataURL(f);
  }));

  Promise.all(readers).then(images=>{
    const batches = JSON.parse(localStorage.getItem("ahla_batches")) || [];
    batches.push({
      id: Date.now(),
      user: username,
      date: new Date().toLocaleString(),
      items,
      images
    });
    localStorage.setItem("ahla_batches", JSON.stringify(batches));
    window.location.href = "sent.html";
  });
}
</script>

</body>
</html>
