<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù | Ahla</title>
<script src="js/roleGuard.js"></script>
<style>
body{font-family:Tahoma;background:#f5f5f5;padding:20px}
nav{background:#222;padding:10px;margin-bottom:15px;display:flex;gap:8px;flex-wrap:wrap}
nav button{background:#6c757d;color:#fff;border:none;padding:7px 12px;border-radius:6px;cursor:pointer}
nav .logout{background:#dc3545}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#4f6f6c;color:#fff}
input{width:100%;padding:6px;box-sizing:border-box}
button.add{background:#6c757d;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
button.save{background:#198754;color:#fff;border:none;padding:8px 16px;border-radius:6px;margin-top:12px;cursor:pointer}
img{width:64px;margin:4px;border:1px solid #ccc;border-radius:6px}
</style>
</head>

<body>

<nav>
  <button type="button" onclick="navGo('add.html')">â• Ø¥Ø¯Ø®Ø§Ù„</button>
  <button type="button" onclick="navGo('sent.html')">ğŸ“¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
  <button type="button" onclick="navBack()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
  <button type="button" class="logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>

<table>
<thead>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody>
<tr>
  <td><input id="code"></td>
  <td><input value="Ø­Ø¨Ø©" disabled></td>
  <td><input id="qty" type="number" min="1"></td>
  <td><input id="price" type="number" step="0.01"></td>
  <td><input id="total" type="number" step="0.01"></td>
  <td><button type="button" class="add" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button></td>
</tr>
</tbody>
</table>

<br>

<table id="itemsTable">
<thead>
<tr>
  <th>#</th>
  <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
  <th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody></tbody>
</table>

<hr>

<h3>ØµÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€“ ØµÙˆØ±Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±)</h3>
<input id="batchImages" type="file" accept="image/*" multiple>
<div id="preview"></div>

<button type="button" class="save" id="sendBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<script>
/* ======== ØªÙ†Ù‚Ù„ Ø«Ø§Ø¨Øª ÙŠØ¹Ù…Ù„ ÙÙŠ GitHub Pages Project ======== */
function basePath(){
  // Ù…Ø«Ø§Ù„: /Ahla/add.html -> base = /Ahla/
  const p = location.pathname;
  return p.substring(0, p.lastIndexOf('/') + 1);
}
function navGo(page){
  location.href = location.origin + basePath() + page;
}
function navBack(){
  // Ø±Ø¬ÙˆØ¹ Ø°ÙƒÙŠ: Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ history ÙŠØ±Ø¬Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
  if (history.length > 1) history.back();
  else {
    const role = localStorage.getItem("role");
    navGo(role === "admin" ? "admin.html" : "add.html");
  }
}

/* ======== Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© ======== */
const codeInput   = document.getElementById("code");
const qtyInput    = document.getElementById("qty");
const priceInput  = document.getElementById("price");
const totalInput  = document.getElementById("total");
const imagesInput = document.getElementById("batchImages");
const preview     = document.getElementById("preview");
const addBtn      = document.getElementById("addBtn");
const sendBtn     = document.getElementById("sendBtn");

const username = localStorage.getItem("user") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

let items = [];
let lastEdit = null;

// Ø­Ø³Ø§Ø¨ Ø°ÙƒÙŠ
priceInput.addEventListener("input", () => {
  lastEdit = "price";
  const q = Number(qtyInput.value);
  const p = Number(priceInput.value);
  if (q > 0 && p >= 0) totalInput.value = (q * p).toFixed(2);
});
totalInput.addEventListener("input", () => {
  lastEdit = "total";
  const q = Number(qtyInput.value);
  const t = Number(totalInput.value);
  if (q > 0 && t >= 0) priceInput.value = (t / q).toFixed(2);
});
qtyInput.addEventListener("input", () => {
  const q = Number(qtyInput.value);
  if (q <= 0) return;
  if (lastEdit === "price" && priceInput.value !== "") totalInput.value = (q * Number(priceInput.value)).toFixed(2);
  if (lastEdit === "total" && totalInput.value !== "") priceInput.value = (Number(totalInput.value) / q).toFixed(2);
});

// Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù (ØªØ­Ù‚Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ)
addBtn.addEventListener("click", () => {
  const code = String(codeInput.value).trim();
  const qty  = Number(qtyInput.value);
  const price = Number(priceInput.value);
  const total = Number(totalInput.value);

  if (code === "" || !Number.isFinite(qty) || qty <= 0) {
    alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
    return;
  }

  items.push({
    code,
    unit:"Ø­Ø¨Ø©",
    qty,
    price: Number.isFinite(price) ? price : 0,
    total: Number.isFinite(total) ? total : qty * (Number.isFinite(price) ? price : 0)
  });

  renderItems();

  codeInput.value = "";
  qtyInput.value = "";
  priceInput.value = "";
  totalInput.value = "";
  lastEdit = null;
});

function renderItems(){
  const tb = document.querySelector("#itemsTable tbody");
  tb.innerHTML = "";
  items.forEach((it,i)=>{
    tb.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${it.code}</td>
        <td>${it.qty}</td>
        <td>${it.price}</td>
        <td>${it.total}</td>
        <td><button type="button" onclick="items.splice(${i},1);renderItems()">âœ–</button></td>
      </tr>`;
  });
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
imagesInput.addEventListener("change", ()=>{
  preview.innerHTML = "";
  [...imagesInput.files].forEach(f=>{
    const r = new FileReader();
    r.onload = ()=> preview.innerHTML += `<img src="${r.result}">`;
    r.readAsDataURL(f);
  });
});

// Ø¥Ø±Ø³Ø§Ù„ (Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª = Ø¥Ø±Ø³Ø§Ù„)
sendBtn.addEventListener("click", ()=>{
  if(items.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù");
  if(imagesInput.files.length === 0) return alert("Ø§Ù„ØµÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©");

  const toBase64 = f => new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.readAsDataURL(f);
  });

  Promise.all([...imagesInput.files].map(toBase64)).then(images=>{
    const batches = JSON.parse(localStorage.getItem("ahla_batches")) || [];
    batches.push({
      id: Date.now(),
      user: username,
      date: new Date().toLocaleString(),
      items,
      images
    });
    localStorage.setItem("ahla_batches", JSON.stringify(batches));

    // ØªÙØ±ÙŠØº + Ø§Ù†ØªÙ‚Ø§Ù„
    items = [];
    renderItems();
    imagesInput.value = "";
    preview.innerHTML = "";

    navGo("sent.html");
  });
});
</script>

<script src="js/auth.js"></script>
</body>
</html>
